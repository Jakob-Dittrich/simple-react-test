pipeline {
    agent any

    triggers {
        cron('H/10 * * * *')  // Run every 10 minutes automatically
    }

    environment {
        BRANCH_NAME_SAFE = "${env.BRANCH_NAME}".replaceAll('/', '-')
        DEPLOY_DIR = "/tmp/deployments/${BRANCH_NAME_SAFE}"
        BUILD_INFO = "${env.BRANCH_NAME}-${env.BUILD_NUMBER}"
        LAST_COMMIT_FILE = "/tmp/deployments/${BRANCH_NAME_SAFE}/.last_commit"
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Building branch: ${env.BRANCH_NAME}"
                echo "Build number: ${env.BUILD_NUMBER}"
                // Multibranch pipeline automatically checks out the code
            }
        }

        stage('Check for Changes') {
            steps {
                script {
                    echo "Checking for changes since last deployment"
                    
                    // Get current commit hash
                    def currentCommit = sh(
                        script: 'git rev-parse HEAD',
                        returnStdout: true
                    ).trim()
                    
                    // Check if there were changes since last deployment
                    def lastCommit = ""
                    def hasChanges = false
                    def triggerType = "SCHEDULED"
                    
                    if (fileExists("${LAST_COMMIT_FILE}")) {
                        lastCommit = readFile("${LAST_COMMIT_FILE}").trim()
                        if (lastCommit != currentCommit) {
                            hasChanges = true
                            triggerType = "CODE_CHANGE"
        stage('Prepare Deployment Directory') {
            steps {
                script {
                    echo "Preparing deployment directory: ${DEPLOY_DIR}"
                    sh """
                        mkdir -p ${DEPLOY_DIR}
                        
                        # Create deployment info file
                        echo "====================================" > ${DEPLOY_DIR}/deployment-info.txt
                        echo "Automatic Deployment Information" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "====================================" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "Deployment ID: ${BUILD_INFO}" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "Deployment Time: \$(date)" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "Trigger Type: ${TRIGGER_TYPE}" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "Branch: ${BRANCH_NAME}" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "Build Number: ${BUILD_NUMBER}" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "Code Changes Detected: ${HAS_CHANGES}" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "Current Commit: ${CURRENT_COMMIT}" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "Previous Commit: ${LAST_COMMIT:-none}" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "Latest Git Commit:" >> ${DEPLOY_DIR}/deployment-info.txt
                        git log -1 --pretty=format:"  Commit: %H%n  Author: %an <%ae>%n  Date: %ai%n  Message: %s%n" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "====================================" >> ${DEPLOY_DIR}/deployment-info.txt
                        
                        # Keep deployment history
                        echo "\$(date) - Build #${BUILD_NUMBER} - ${TRIGGER_TYPE} - \$(git log -1 --pretty=format:'%h - %s')" >> ${DEPLOY_DIR}/deployment-history.log
                        
                        # Save current commit for next comparison
                        echo "${CURRENT_COMMIT}" > ${LAST_COMMIT_FILE}
                    """
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    echo "Simulating deployment by moving Checkfile.txt"
                    // -${BUILD_INFO}.txt
                    sh """
                        if [ -f Checkfile.txt ]; then
                            cp Checkfile.txt ${DEPLOY_DIR}/Checkfile.txt
                            echo "Checkfile.txt copied to ${DEPLOY_DIR}"
                            ls -la ${DEPLOY_DIR}
                        else
                            echo "ERROR: Checkfile.txt not found in workspace!"
                            exit 1
                        fi
                    """
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                script {
                    echo "Verifying deployment"
                    sh """
                        echo "Contents of deployment directory:"
                        ls -la ${DEPLOY_DIR}
                        echo ""
                        echo "Deployment info:"
                        cat ${DEPLOY_DIR}/deployment-info.txt
                    """
                }
            }
        }
    }

    post {
        success {
            echo """
            ================================
            Deployment Successful!
            ================================
            Branch: ${env.BRANCH_NAME}
            Build: ${env.BUILD_NUMBER}
            Deployed to: ${DEPLOY_DIR}
            File: Checkfile-${BUILD_INFO}.txt
            ================================
            """
        }
        failure {
            echo "Pipeline failed for branch ${env.BRANCH_NAME}!"
        }
        always {
            echo "Pipeline completed for branch: ${env.BRANCH_NAME}"
        }
    }
}
