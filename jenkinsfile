pipeline {
    agent any

    triggers {
        cron('H/2 * * * *')  // Run every 2 minutes automatically
    }

    environment {
        BRANCH_NAME_SAFE = "${env.BRANCH_NAME}".replaceAll('/', '-')
        DEPLOY_DIR = "/tmp/deployments/${BRANCH_NAME_SAFE}"
        BUILD_INFO = "${env.BRANCH_NAME}-${env.BUILD_NUMBER}"
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Building branch: ${env.BRANCH_NAME}"
                echo "Build number: ${env.BUILD_NUMBER}"
                // Multibranch pipeline automatically checks out the code
            }
        }

        stage('Check for Changes') {
            steps {
                script {
                    echo "Checking for changes since last deployment"
                    def hasChanges = sh(
                        script: '''
                            if [ -f .git/refs/heads/${BRANCH_NAME} ]; then
                                # Get last commit info
                                git log -1 --pretty=format:"%H|%an|%ae|%ai|%s"
                            else
                                echo "NEW_BRANCH"
                            fi
                        ''',
                        returnStdout: true
                    ).trim()
                    
                    env.GIT_COMMIT_INFO = hasChanges
                    echo "Latest commit info: ${hasChanges}"
                }
            }
        }

        stage('Prepare Deployment Directory') {
            steps {
                script {
                    echo "Preparing deployment directory: ${DEPLOY_DIR}"
                    sh """
                        mkdir -p ${DEPLOY_DIR}
                        
                        # Create deployment info file
                        echo "====================================" > ${DEPLOY_DIR}/deployment-info.txt
                        echo "Automatic Deployment Information" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "====================================" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "Deployment ID: ${BUILD_INFO}" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "Deployment Time: \$(date)" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "Branch: ${BRANCH_NAME}" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "Build Number: ${BUILD_NUMBER}" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "Latest Git Commit:" >> ${DEPLOY_DIR}/deployment-info.txt
                        git log -1 --pretty=format:"  Commit: %H%n  Author: %an <%ae>%n  Date: %ai%n  Message: %s%n" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "" >> ${DEPLOY_DIR}/deployment-info.txt
                        echo "====================================" >> ${DEPLOY_DIR}/deployment-info.txt
                        
                        # Keep deployment history
                        echo "\$(date) - Build #${BUILD_NUMBER} - \$(git log -1 --pretty=format:'%h - %s')" >> ${DEPLOY_DIR}/deployment-history.log
                    """
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    echo "Simulating deployment by moving Checkfile.txt"
                    // -${BUILD_INFO}.txt
                    sh """
                        if [ -f Checkfile.txt ]; then
                            cp Checkfile.txt ${DEPLOY_DIR}/Checkfile.txt
                            echo "Checkfile.txt copied to ${DEPLOY_DIR}"
                            ls -la ${DEPLOY_DIR}
                        else
                            echo "ERROR: Checkfile.txt not found in workspace!"
                            exit 1
                        fi
                    """
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                script {
                    echo "Verifying deployment"
                    sh """
                        echo "Contents of deployment directory:"
                        ls -la ${DEPLOY_DIR}
                        echo ""
                        echo "Deployment info:"
                        cat ${DEPLOY_DIR}/deployment-info.txt
                    """
                }
            }
        }
    }

    post {
        success {
            echo """
            ================================
            Deployment Successful!
            ================================
            Branch: ${env.BRANCH_NAME}
            Build: ${env.BUILD_NUMBER}
            Deployed to: ${DEPLOY_DIR}
            File: Checkfile-${BUILD_INFO}.txt
            ================================
            """
        }
        failure {
            echo "Pipeline failed for branch ${env.BRANCH_NAME}!"
        }
        always {
            echo "Pipeline completed for branch: ${env.BRANCH_NAME}"
        }
    }
}
