pipeline {
    agent any

    environment {
        BRANCH_NAME_SAFE = "${env.BRANCH_NAME}".replaceAll('/', '-')
        DEPLOY_DIR = "/tmp/deployments/${BRANCH_NAME_SAFE}"
        BUILD_INFO = "${env.BRANCH_NAME}-${env.BUILD_NUMBER}"
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Building branch: ${env.BRANCH_NAME}"
                echo "Build number: ${env.BUILD_NUMBER}"
                // Multibranch pipeline automatically checks out the code
            }
        }

        stage('Prepare Deployment Directory') {
            steps {
                script {
                    echo "Preparing deployment directory: ${DEPLOY_DIR}"
                    sh """
                        mkdir -p ${DEPLOY_DIR}
                        echo "Deployment for ${BUILD_INFO}" > ${DEPLOY_DIR}/deployment-info.txt
                        echo "Timestamp: \$(date)" >> ${DEPLOY_DIR}/deployment-info.txt
                    """
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    echo "Simulating deployment by moving Checkfile.txt"
                    sh """
                        if [ -f Checkfile.txt ]; then
                            cp Checkfile.txt ${DEPLOY_DIR}/Checkfile-${BUILD_INFO}.txt
                            echo "Checkfile.txt copied to ${DEPLOY_DIR}"
                            ls -la ${DEPLOY_DIR}
                        else
                            echo "ERROR: Checkfile.txt not found in workspace!"
                            exit 1
                        fi
                    """
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                script {
                    echo "Verifying deployment"
                    sh """
                        echo "Contents of deployment directory:"
                        ls -la ${DEPLOY_DIR}
                        echo ""
                        echo "Deployment info:"
                        cat ${DEPLOY_DIR}/deployment-info.txt
                    """
                }
            }
        }
    }

    post {
        success {
            echo """
            ================================
            Deployment Successful!
            ================================
            Branch: ${env.BRANCH_NAME}
            Build: ${env.BUILD_NUMBER}
            Deployed to: ${DEPLOY_DIR}
            File: Checkfile-${BUILD_INFO}.txt
            ================================
            """
        }
        failure {
            echo "Pipeline failed for branch ${env.BRANCH_NAME}!"
        }
        always {
            echo "Pipeline completed for branch: ${env.BRANCH_NAME}"
        }
    }
}
